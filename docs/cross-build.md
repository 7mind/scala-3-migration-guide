# Cross-building

Library authors are likely to want their library compatible with Scala 3 and Scala 2, so that it can continuously evolve without frustrating anyone. Cross-building has been the best solution so far to do so.

## How to cross-build your library with Dotty

This section lists incompatibilities between Scala 3 and Scala 2, and solutions for cross-compiling the source code.

### The extractor `unapply` for case classes doesn’t return an `Option` anymore

In Scala, case classes have an associated extractor operation generated by the compiler in their companion object. Their signature is different in Scala 2 and Scala 3. This can cause incompatibilities if your code relies on the signature of the `unapply` operation produced by a specific version of the compiler. Note that this problem does not affect user-defined extractors, whose signature stays the same across Scala versions.

Given the following case class definition:

~~~ scala
case class Location(lat: Double, long: Double)
~~~

The Scala 2 compiler produces the following `unapply` method:

~~~ scala
object Location {
  def unapply(location: Location): Option[(Double, Double)] = Some((location.lat, location.long))
}
~~~

Whereas the Scala 3 compiler produces the following `unapply` method:

~~~ scala
object User {
  def unapply(location: Location): Location = location
}
~~~

The operation `unapply` is used under the hood by pattern matching. This usage remains cross-compatible between Scala 2 and Scala 3.

However, if your code explicitly calls the `unapply` operation it has to be adapted. A common situation where `unapply` is explicitly called is serialization/deserialization. For instance, consider the following JSON encoder, taken from the documentation of [Play framework](https://www.playframework.com/documentation/2.8.x/ScalaJsonCombinators#Writes):

~~~ scala
implicit val locationWrites: Writes[Location] = (
  (JsPath \ "lat").write[Double] and
    (JsPath \ "long").write[Double]
)(unlift(Location.unapply)) // Error with Scala 3
~~~

This code doesn’t compile with Scala 3. A solution to make it compile is to inline the implementation of the Scala 2 `unapply` operation:

~~~ scala
implicit val locationWrites: Writes[Location] = (
  (JsPath \ "lat").write[Double] and
    (JsPath \ "long").write[Double]
)(location => (location.lat, location.long)) // Compiles with both Scala 2 and Scala 3
~~~

### Other incompatibilities

[Contributors Welcome!](CONTRIBUTING.md)

## Additional Resources

- [Sbt Reference Manual](https://www.scala-sbt.org/1.x/docs/Cross-Build.html)
- [Dotty Getting Started](https://dotty.epfl.ch/docs/usage/getting-started.html)
- [Scala Blog Post: The Road to Scala 3](https://www.scala-lang.org/2019/12/18/road-to-scala-3.html#how-can-i-contribute)
